---
- name: Install pyenv
  block:
  - import_tasks: git.yml
  - import_tasks: user.yml
  - import_tasks: zsh.yml

  - name: Install packages via apt
    apt: name={{item}} state=present install_recommends=no
    become: true
    loop:
      - make 
      - build-essential 
      - libssl-dev 
      - zlib1g-dev 
      - libbz2-dev 
      - libreadline-dev 
      - libsqlite3-dev 
      - wget 
      - curl 
      - llvm 
      - libncurses5-dev 
      - xz-utils 
      - tk-dev 
      - libxml2-dev 
      - libxmlsec1-dev 
      - libffi-dev 
      - liblzma-dev

  - name: Check if {{install_path}} contains files
    find: paths={{install_path}}
    register: installed_files
  
  - block:
    - name: Create {{install_path}}
      file: path={{install_path}} state=directory mode=0777
      become: true

    - name: Clone {{pyenv_url}} -> {{install_path}}
      git: repo={{pyenv_url}} dest={{install_path}}
    
    - name: Clone {{pyenv_virtualenv_url}} -> {{install_path}}/plugins/pyenv-virtualenv
      git: repo={{pyenv_virtualenv_url}} dest={{install_path}}/plugins/pyenv-virtualenv
    when: installed_files.matched == 0
  
  - name: Write block to {{profile_path}}
    blockinfile:
      path: "{{profile_path}}"
      state: present
      marker: "# {mark} pyenv"
      block: |
        export PYENV_ROOT={{install_path}}
        export PATH=$PYENV_ROOT/bin:$PATH
        eval "$(pyenv init -)"
        eval "$(pyenv virtualenv-init -)"
    become: true 
    
  vars:
    install_path: /opt/pyenv
    pyenv_url: https://github.com/pyenv/pyenv.git
    pyenv_virtualenv_url: https://github.com/pyenv/pyenv-virtualenv
    profile_path: /home/{{user}}/.zshrc
